# ES

可以用于全文搜索，结构化搜索以及近实时分析

架构：

cluster es是分布式的，有多个节点构成集群，集群具有很强的扩展性。

node 每个启动的es实例就是一个节点，可以随时加入和脱离集群

index 相当于数据库  

document 相当于一条记录

分片shard es处理的最小单元，一个分片是一个索引 ， 一个包含倒排索引的文件目录  分片越多搜索越慢

分段 segment 索引再分割成小单元 分段越多搜索越慢 分段不会被修改 索引新的文档会创建新的分段

分段会持续地被合并 删除文档不会真的删除 只是标记



分片：扩展和容灾

 扩容：一个索引的所有分片会自动均匀的分布在所有节点中，

加入新节点后，原集群节点的分片，会部分迁移到新节点。

设置分片数量稍微大于节点数量，有利于横向扩展，分片蔓延到新的节点，每个节点都有分片

容灾：一个节点挂掉后，副本分片将自动提升为主分片，保证能够构成完整索引，索引健康状态为黄色



索引和搜索数据与分片的交互：

索引请求：索引文档请求到一个节点，会分配到一个主分片，主分片同步到副本分片，返回成功的结果

​				副本分片越多，同步要花费的时间越长，所以索引请求完成的越慢。

搜索请求：索引请求到一个节点，节点转发请求到本节点下的一个分片，到其他的节点的另一个分片，所有分片都返回搜索结果到发起节点，发起节点返回给请求方。



索引 更新 删除

更新文档：segement创建后 不能删除。 更新实际上是创建了一个新的删掉旧的，删掉旧的是给旧的打上删除标记，等到合并分段才会触发真的删除，删除会消耗性能

文档更新包括 检索文档，处理文档， 重新索引文档。

三种方式  整段更新，字段合并，若存在则放弃更新。

使用自动生成id来插入新文档，可以节省检索文档所耗费的资源。



**通过文档版本实现并发控制**   类似乐观锁



删除文档

可以通过id删除单个，也可以通过条件批量删除

删除会拖慢查询和索引的速度，假删除， 查询后还要检索一遍是否数据是删除的，

分段合并时才会彻底删除， es不推荐使用删除

删除索引  



关闭索引：

索引关闭后，不能读取和写入，直到再次打开。

冻结索引：

冻结介于打开和关闭之间，不能写入，分片开销很小，。

 reindex

复制一个索引，用于重建索引，可用于提取字段，可跨集群复制





使用反向索引 倒排索引 根据内容中的关键字简建立索引。

索引，类型 文档  -》 数据库， 表， 行数据

倒排索引：



#### Elasticsearch搜索的过程描述	Query Then Fetch

在初始查询阶段时，查询会广播到索引中每一个分片拷贝，每个分片在**本地**执行搜索并构建一个匹配文档的大小为 from + size 的**优先队列**

每个分片**返回各自优先队列中 所有文档的 ID 和排序值 给协调节点**，它合并这些值到自己的**优先队列**中来产生一个全局排序后的结果列表。

**取回阶段**，协调节点辨别出哪些文档需要被取回并向相关的分片提交多个 GET 请求。每个分片加载并丰富文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回了，协调节点返回结果给客户端。

### 写数据过程

1. 客户端通过hash选择一个node发送请求，这个node被称做coordinating node（协调节点），
2. 协调节点对docmount进行路由，将请求转发给到对应的primary shard
3. primary shard 处理请求，将数据同步到所有的replica shard
4. 此时协调节点，发现primary shard 和所有的replica shard都处理完之后，就反馈给客户端。

